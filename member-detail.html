<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>멤버 상세 페이지</title>
    <!-- JQuery import 하기 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap import 하기 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Chiron+GoRound+TC:wght@200..900&family=Gowun+Dodum&family=Jua&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap");

      * {
        font-family: "Chiron GoRound TC", sans-serif;
      }

      .header {
        background-color: lightsteelblue;
        height: 50px;
      }

      #home {
        font-size: 27px;
      }

      .member-card .card {
        width: 800px; /* 카드 가로 */
        height: 500px;
        margin: 30px auto; /* 화면 가운데 정렬 + 위아래 여백 */
      }

      #comment-title {
        margin: 20px 0px 20px 100px;
        font-size: 25px;
      }

      .comment-container {
        width: 1000px;
        align-items: center;
        justify-content: center;

        margin: 30px auto;
      }

      .comment-register {
        display: flex;
        flex-direction: column;
        align-items: center;

        border-radius: 5px;
      }

      .comment-register > input {
        display: block;
        margin: 5px;
      }

      #name-register {
        width: 200px;
        height: 30px;

        margin-left: 5px;
        padding: 10px 0px 10px 7px;

        border: 1px solid lightgray;
        border-radius: 5px;
      }

      #content-register {
        width: 80%;
        height: 120px;

        padding: 5px 0px 5px 10px;

        border: 1px solid lightgray;
        border-radius: 5px;
      }

      #register-btn {
        background-color: black;
        color: white;
        height: 40px;
        width: 85px;

        display: inline;
        margin: 0px 5px 10px 510px;
        padding: 5px 5px 5px 5px;

        border: 1px solid black;
        border-radius: 5px;
      }

      .comment {
        max-width: 800px;
        min-height: 50px; /* 내용이 없을 때 최소 높이 */
        max-height: 150px; /* 너무 길면 스크롤 처리 가능 */
        overflow: auto; /* max-height를 넘어가면 스크롤 */
        margin-bottom: 10px;

        margin-top: 10px;
        margin-left: 100px;
      }

      .name {
        height: 25px;
        padding: 1px 0px 2px 5px;
        background-color: lightsteelblue;
        font-size: medium;
        border-radius: 2px;
      }

      .content {
        font-size: medium;
        margin: 0px;
        padding-bottom: 7px;
        padding-left: 4px;
        border-bottom: 1px solid #ccc;
      }

      #member-img {
        height: 300px;
      }
    </style>

    <script type="module">
      // Firebase SDK 라이브러리 가져오기
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        getDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      // Firebase 구성 정보 설정
      const firebaseConfig = {
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        apiKey: "AIzaSyAaN0oP7dRX_fkIOGG6RZiq-w-XndV6c1k",
        authDomain: "sparta-35436.firebaseapp.com",
        projectId: "sparta-35436",
        storageBucket: "sparta-35436.firebasestorage.app",
        messagingSenderId: "337029385282",
        appId: "1:337029385282:web:bc784eb4944380588e71db",
        measurementId: "G-6WRJLTVW0J",
      };

      // Firebase 인스턴스 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const params = new URLSearchParams(window.location.search);
      const memberId = params.get("id");
      console.log(memberId);

      if (memberId) {
        const docRef = doc(db, "members", memberId);
        const memberSnap = await getDoc(docRef);

        if (memberSnap.exists()) {
          const data = memberSnap.data();
          let name = data["name"];
          let mbti = data["mbti"];

          let temp_html = `
            <div class="card mb-3" style="max-width: 900px;">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="..." class="img-fluid rounded-start" alt="멤버 사진"/>
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">이름: ${name}</h5>
                    <p class="member-mbti">mbti: ${mbti}</p>
                    <p class="member-mbti">자기소개: ...</p>
                  </div>
                </div>
              </div>
            </div>`;
          $(".member-card").append(temp_html);
        }
      }

      $("#register-btn").click(async function () {
        let name = $("#name-register").val();
        let content = $("#content-register").val();

        let doc = {
          name: name,
          content: content,
          memberId: memberId,
        };

        await addDoc(collection(db, "comments"), doc);
        alert("등록 완료!");
        window.location.reload();
      });

      // 댓글 불러오기
      let docs = await getDocs(collection(db, "comments"));
      docs.forEach((doc) => {
        let row = doc.data();

        if (row.memberId === memberId) {
          // 입력값 가져오기
          let name = row["name"];
          let content = row["content"];
          let temp_html = ``;

          if (!name) {
            temp_html = `
            <div class="comment">
              <p class="name">User</p>
              <p class="content">${content}</p>
            </div>`;
          } else {
            temp_html = `
            <div class="comment">
              <p class="name">${name}</p>
              <p class="content">${content}</p>
            </div>`;
          }

          $(".comment-wrap").append(temp_html);
        }
      });
    </script>
  </head>
  <body>
    <div class="header">
      <a href="index.html" id="home">2gether</a>
    </div>

    <div class="member-card"></div>

    <div class="comment-container">
      <p id="comment-title">방명록</p>

      <div class="comment-register">
        <div>
          <input
            type="text"
            id="name-register"
            maxlength="20"
            placeholder="닉네임"
          />
          <button id="register-btn" type="button">등록하기</button>
        </div>

        <input
          type="text"
          id="content-register"
          maxlength="140"
          placeholder="방명록을 작성하세요."
        />
      </div>

      <div class="comment-wrap"></div>
    </div>
  </body>
</html>